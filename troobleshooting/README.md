# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

        Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её нужно прервать.

        Вы как инженер поддержки решили произвести данную операцию:

        напишите список операций, которые вы будете производить для остановки запроса пользователя
        предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

Ответ: 

Я бы настроил мониторинг таких долгих запросов и автоматически килял бы все такие запросы, после чего просил бы таких разрабов показать их запрос.

Для начала найти данную операцию, которая длится больше 3х минут поможет db.currentOp({"secs_running":{$gte: 180}}), после чего можно кильнуть её командой db.killOp(opid). Чтоб такого не повторялось можно выставить maxTimeMS() для запросов CRUD и оптимизировать запросы, построить соответствующие индексы.

## Задача 2

        Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.

        При масштабировании сервиса до N реплик вы увидели, что:

          сначала рост отношения записанных значений к истекшим
          Redis блокирует операции записи
          Как вы думаете, в чем может быть проблема?

В первую очередь идти в мониторинг и смотреть занятость ресурсов, и постараться найти проблему там, или хотя бы найти момент времени когда начались неполадки.

Если в реплике много данных нагрузится сетка так как будет тянуться база, могут блокироваться запросы

Скорее всего перестало хватать RAM, база начала увеличиваться и заняла всю свободную память, по-этому операции записи перестали исполняться.

## Задача 3

      Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы, пользователи начали жаловаться на ошибки вида:

      InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
      Как вы думаете, почему это начало происходить и как локализовать проблему?

      Какие пути решения данной проблемы вы можете предложить? 

Для начала посмотреть мониторинг БД, найти момент аномалий бд, смотреть логи, посмотреть запросы, которые пытаются выполнить эти пользователи, посмотреть на какой стороне был дроп tcpdump-ом если база большая может они хотят выдернуть огромную кучу данных и запрос невыполняется из за объема этих данных, может нужно увеличить max_connections:, моожет данные BLOB больше, чем значение max_allowed_packet,
Возможно еще что проблема в таймаутах, connect_timeout, net_read_timeout, могут быть проблемы в сети также. По итогу: смотрим мониторинг, смотрим запрос, который пытаются выполнить из за которого возникает ошибка, понемногу эксперементируем с конфигурацией указанных параметров.

## Задача 4

      Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объемом данных лучше, чем MySQL.

      После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

      postmaster invoked oom-killer

      Как вы думаете, что происходит?

      Как бы вы решили данную проблему?

oom-killer это это компонент ядра Linux, она завершает процесс postgres если не хватает ОЗУ, отключать его нерекомендуется, чтоб не положить систему совсем.
Для начала просто посмотреть утилитой htop какие процессы съедают больше всего памяти, может есть какой то другой процесс или служба, из-за которого постргре не хватает озу и перенести постгрес на отдельную машину, если всю память съедает сам постгрес, выставить в настройках доступную ему память, но одного такого параметра для Postgres вроде нет, по этому вроде фактический максимальный объем ОЗУ = shared_buffers+ ( temp_buffers+ work_mem) *max_connections (Возможно ошибаюсь, просто нагуглил) 

Смотреть мониторинг какой процесс начал жрать трафик, в какой момент, смотреть нагрузку на сеть, диски, память

В первую очередь поработать с конфигурацией (если не помогло то докинуть ресурсов)
